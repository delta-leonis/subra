package io.leonis.subra.ipc.network;

import io.leonis.algieba.Temporal;
import io.leonis.subra.game.data.*;
import io.leonis.subra.ipc.network.GameDeducer.GameFrame;
import io.leonis.subra.ipc.serialization.protobuf.*;
import io.leonis.subra.ipc.serialization.protobuf.SSLVisionDeducer.VisionPacket;
import io.leonis.subra.ipc.serialization.protobuf.vision.GoalsDeducer;
import io.leonis.zosma.game.engine.*;
import java.util.Set;
import lombok.*;
import lombok.experimental.Delegate;
import org.reactivestreams.Publisher;
import reactor.core.publisher.Flux;

/**
 * The Class GamePublisher.
 *
 * This class contains the functionality of a {@link Publisher} of {@link GameFrame}.
 *
 * @author Rimon Oz
 */
@AllArgsConstructor
<<<<<<< HEAD
public final class GamePublisher implements Publisher<GameFrame> {
  private final Publisher<WrapperPacket> visionPublisher;
  private final Publisher<SSL_Referee> refboxPublisher;
=======
public final class GamePublisher<I extends WrapperPacketSupplier & SSLRefereeSupplier> implements Deducer<I, GameFrame> {
>>>>>>> 4bfbf9e... Introduce WrapperPacket and SSLReferee suppliers

  @Override
  public Publisher<GameFrame> apply(
      final Publisher<I> entryPublisher) {
    return Flux.from(entryPublisher)
        .transform(new ParallelDeducer<>(
            new SSLVisionDeducer<>(),
            new SSLRefboxDeducer<>(),
            GameFrameWithoutGoals::new))
        .transform(new ParallelDeducer<>(
          new IdentityDeducer<>(),
          new GoalsDeducer<>(),
          GameFrame::new));
  }

  @Value
  private static class GameFrameWithoutGoals
      implements Player.SetSupplier, GoalDimension.Supplier, Field.Supplier, Ball.SetSupplier,
      Referee.Supplier {
    private final Set<Player> players;
    private final GoalDimension goalDimension;
    private final Set<Ball> balls;
    private final Field field;
    private final Referee referee;

    GameFrameWithoutGoals(final VisionPacket packet, final Referee referee) {
      this.goalDimension = packet.getGoalDimension();
      this.players = packet.getPlayers();
      this.balls = packet.getBalls();
      this.field = packet.getField();
      this.referee = referee;
    }
  }

  @Value
  public static class GameFrame
      implements Player.SetSupplier, Goal.SetSupplier, Field.Supplier, Ball.SetSupplier,
      Referee.Supplier, Temporal {
    @Delegate
    private final GameFrameWithoutGoals state;
    @Delegate
    private final Goal.SetSupplier goalSupplier;
    private final long timestamp = System.currentTimeMillis();
  }
}
